---           
layout: post
title: Arduino : Serial communication with interrupt 
date: 2014-09-10 19:47:15 UTC
updated: 2014-09-10 19:47:15 UTC
comments: false
categories: 
---

<span style="font-family: inherit;">The other day, I helped Joe with his project. The project requires the Arduino to listen to the Bluetooth communication (sent via an Android App) while also running its own program. The Bluetooth module uses the serial comm. To make it work, I'll use this basic code for the interrupt which when triggered, it takes the Bluetooth communication's input.</span><br /><br /><span style="font-family: Courier New, Courier, monospace; font-weight: bold;">// To use this example, you have to connect Rx pin (digital pin 0) to interrupt 0 pin (digital pin 2).</span><br /><span style="font-family: Courier New, Courier, monospace;"><b>void setup()</b></span><br /><span style="font-family: Courier New, Courier, monospace;"><b>{</b></span><br /><span style="font-family: Courier New, Courier, monospace;"><b>&nbsp; &nbsp; // Using interrupt 0 on digital pin 2.</b></span><br /><span style="font-family: Courier New, Courier, monospace;"><b>&nbsp; &nbsp; pinMode(2, INPUT);</b></span><br /><span style="font-family: Courier New, Courier, monospace;"><b>&nbsp; &nbsp; digitalWrite(2, LOW);</b></span><br /><span style="font-family: Courier New, Courier, monospace;"><b>&nbsp; &nbsp;</b></span><br /><span style="font-family: Courier New, Courier, monospace;"><b>&nbsp; &nbsp; Serial.begin(9600);</b></span><br /><span style="font-family: Courier New, Courier, monospace;"><b>&nbsp; &nbsp; attachInterrupt(0, serialInterrupt, CHANGE);</b></span><br /><b><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; // Used to signal that main loop is alive.</span></b><br /><span style="font-family: Courier New, Courier, monospace;"><b>&nbsp; &nbsp; pinMode(4, OUTPUT);</b></span><br /><span style="font-family: Courier New, Courier, monospace;"><b>&nbsp; &nbsp; digitalWrite(4, LOW);</b></span><br /><b><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; // Used to signal that Serial input was read.</span></b><br /><span style="font-family: Courier New, Courier, monospace;"><b>&nbsp; &nbsp; pinMode(5, OUTPUT);</b></span><br /><span style="font-family: Courier New, Courier, monospace;"><b>&nbsp; &nbsp; digitalWrite(5, LOW);</b></span><br /><span style="font-family: Courier New, Courier, monospace;"><b>}</b></span><br /><b><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;">void loop()</span></b><br /><span style="font-family: Courier New, Courier, monospace;"><b>{</b></span><br /><span style="font-family: Courier New, Courier, monospace;"><b>&nbsp; // Do something using even delays. There is an interrupt for that (Serial I/O)!</b></span><br /><b><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;">&nbsp; // Blink led to signal loop is alive.</span></b><br /><span style="font-family: Courier New, Courier, monospace;"><b>&nbsp; digitalWrite(4, HIGH);</b></span><br /><span style="font-family: Courier New, Courier, monospace;"><b>&nbsp; delay(500);</b></span><br /><b><br /></b><span style="font-family: Courier New, Courier, monospace;"><b>&nbsp; digitalWrite(4, LOW);</b></span><br /><span style="font-family: Courier New, Courier, monospace;"><b>&nbsp; delay(500);</b></span><br /><span style="font-family: Courier New, Courier, monospace;"><b>}</b></span><br /><b><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;">// Volatile, since it is modified in an ISR.</span></b><br /><span style="font-family: Courier New, Courier, monospace;"><b>volatile boolean inService = false;</b></span><br /><b><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;">void serialInterrupt()</span></b><br /><span style="font-family: Courier New, Courier, monospace;"><b>{</b></span><br /><span style="font-family: Courier New, Courier, monospace;"><b>&nbsp; // Trick: since Serial I/O in interrupt driven, we must reenable interrupts while in this Interrupt Service Routine.</b></span><br /><span style="font-family: Courier New, Courier, monospace;"><b>&nbsp; // But doing so will cause the routine to be called nestedly, causing problems.</b></span><br /><span style="font-family: Courier New, Courier, monospace;"><b>&nbsp; // So we mark we are already in service.</b></span><br /><b><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;">&nbsp; // Already in service? Do nothing.</span></b><br /><span style="font-family: Courier New, Courier, monospace;"><b>&nbsp; if (inService) return;</b></span><br /><b><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;">&nbsp; // You was not in service. Now you are.</span></b><br /><span style="font-family: Courier New, Courier, monospace;"><b>&nbsp; inService = true;</b></span><br /><b><br /></b><span style="font-family: Courier New, Courier, monospace;"><b>&nbsp; // Reenable interrupts, to allow Serial to work. We do this only if inService is false.</b></span><br /><span style="font-family: Courier New, Courier, monospace;"><b>&nbsp; interrupts();</b></span><br /><b><br /></b><span style="font-family: Courier New, Courier, monospace;"><b>&nbsp; // Allow serial to read at least one byte.</b></span><br /><span style="font-family: Courier New, Courier, monospace;"><b>&nbsp; while(!Serial.available());</b></span><br /><b><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;">&nbsp; // Blink led to signal Serial data arrived.</span></b><br /><span style="font-family: Courier New, Courier, monospace;"><b>&nbsp; digitalWrite(5, !digitalRead(5));</b></span><br /><span style="font-family: Courier New, Courier, monospace;"><b>&nbsp; byte data = Serial.read();</b></span><br /><b><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;">&nbsp; // Echo data back to developer ;-)</span></b><br /><span style="font-family: Courier New, Courier, monospace;"><b>&nbsp; Serial.print(data);</b></span><br /><b><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;">&nbsp; // Job done.</span></b><br /><span style="font-family: Courier New, Courier, monospace;"><b>&nbsp; inService = false;</b></span><br /><span style="font-family: Courier New, Courier, monospace;"><b>}</b></span>